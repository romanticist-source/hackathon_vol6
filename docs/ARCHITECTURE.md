# アーキテクチャ設計

## 概要

Browser to VSCode Syncは、ブラウザの開発者ツールで行ったHTML/CSSの変更をVS Codeにリアルタイム同期するシステムです。

## システム構成

```
┌─────────────────┐    WebSocket    ┌─────────────────┐
│   Chrome        │ ◄─────────────► │   VS Code       │
│   Extension     │                 │   Extension     │
└─────────────────┘                 └─────────────────┘
         │                                   │
         │                                   │
         ▼                                   ▼
┌─────────────────┐                 ┌─────────────────┐
│   Web Page      │                 │   Local Files   │
│   (DevTools)    │                 │   (HTML/CSS)    │
└─────────────────┘                 └─────────────────┘
```

## コンポーネント詳細

### 1. Chrome拡張機能

#### 1.1 コンテンツスクリプト (`content.js`)
- **役割**: ページ内で実行され、開発者ツールの変更を監視
- **機能**:
  - DOM要素の属性変更監視
  - CSSプロパティ変更監視
  - 開発者ツールの開閉状態監視
  - WebSocket通信の管理

#### 1.2 バックグラウンドスクリプト (`background.js`)
- **役割**: 拡張機能のライフサイクル管理
- **機能**:
  - 拡張機能のインストール/更新処理
  - タブ更新時のコンテンツスクリプト再注入
  - ポップアップの表示制御

#### 1.3 ポップアップ (`popup.html`, `popup.js`)
- **役割**: ユーザーインターフェース
- **機能**:
  - 接続状態の表示
  - 再接続機能
  - 使用方法の表示

### 2. VS Code拡張機能

#### 2.1 メイン拡張機能 (`extension.ts`)
- **役割**: 拡張機能のエントリーポイント
- **機能**:
  - WebSocketサーバーの起動/停止
  - コマンドの登録
  - 設定の管理
  - メッセージのルーティング

#### 2.2 ファイル同期マネージャー (`fileSyncManager.ts`)
- **役割**: ファイル操作の管理
- **機能**:
  - URLからローカルファイルパスの解決
  - HTML要素の検索と更新
  - CSSプロパティの更新
  - ファイルの保存

## 通信プロトコル

### WebSocketメッセージ形式

#### ブラウザ → VS Code

```json
{
  "type": "attribute_change",
  "data": {
    "url": "http://localhost:3000/index.html",
    "selector": "#my-element",
    "attribute": "class",
    "value": "new-class"
  }
}
```

```json
{
  "type": "style_change",
  "data": {
    "url": "http://localhost:3000/index.html",
    "selector": "#my-element",
    "property": "background-color",
    "value": "red"
  }
}
```

#### VS Code → ブラウザ

```json
{
  "type": "connection",
  "data": {
    "status": "connected",
    "timestamp": 1234567890
  }
}
```

## データフロー

### 1. 属性変更の同期

1. ユーザーが開発者ツールで要素の属性を変更
2. コンテンツスクリプトが変更を検知
3. セレクタを生成
4. WebSocketでVS Codeにメッセージ送信
5. VS Codeがローカルファイルを特定
6. 該当要素を検索
7. 属性を更新
8. ファイルを保存

### 2. スタイル変更の同期

1. ユーザーが開発者ツールでCSSプロパティを変更
2. コンテンツスクリプトが変更を検知
3. セレクタを生成
4. WebSocketでVS Codeにメッセージ送信
5. VS Codeがローカルファイルを特定
6. 該当要素を検索
7. style属性を更新
8. ファイルを保存

## セキュリティ考慮事項

### 1. 通信セキュリティ
- WebSocketはlocalhostでのみ動作
- 外部からのアクセスは許可しない

### 2. ファイルアクセス
- 設定されたワークスペースルート内のファイルのみアクセス
- 相対パスでのファイル解決

### 3. 権限管理
- Chrome拡張機能は最小限の権限のみ要求
- VS Code拡張機能はワークスペース内のファイルのみ操作

## パフォーマンス考慮事項

### 1. 変更検知の最適化
- 開発者ツールが開いている時のみ監視
- デバウンス処理で過度な更新を防止

### 2. ファイル操作の最適化
- バッチ処理で複数変更をまとめて処理
- ファイルの差分のみ更新

### 3. メモリ管理
- WebSocket接続の適切な管理
- 不要なイベントリスナーの削除

## 拡張性

### 1. 将来的な機能追加
- 要素の追加・削除の同期
- JavaScriptファイルの同期
- 外部CSSファイルの完全同期
- 複数ブラウザ対応

### 2. プラグインアーキテクチャ
- ファイル形式別の同期処理
- カスタムセレクタ生成
- カスタム変換ルール

## 制限事項（MVP）

### 1. 技術的制限
- 要素の追加・削除は同期不可
- JavaScriptファイルは同期不可
- 外部CSSファイルは限定的な同期

### 2. ブラウザ制限
- Chromeのみ対応
- localhostページでのみ動作

### 3. セレクタ制限
- ID、クラス、タグ名ベースのセレクタのみ
- 複雑なCSSセレクタは未対応 